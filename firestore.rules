rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user role from user document (for customers)
    function getUserRole() {
      return isAuthenticated() ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role : null;
    }
    
    // Helper function to check if user is admin (checks admins collection)
    function isAdmin() {
      return isAuthenticated() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Helper function to check if user is moderator or admin
    function isModerator() {
      return isAdmin() || (isAuthenticated() && getUserRole() == 'moderator');
    }
    
    // Helper function to check if user has specific permission
    function hasPermission(resource, action) {
      return isAuthenticated() && (
        isAdmin() || 
        (resource in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions &&
         action in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions[resource])
      );
    }
    
    // Users collection - enhanced security
    match /users/{userId} {
      // Users can read and update their own profile
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      
      // Admins can read and write all user profiles
      allow read, write: if isAdmin();
      
      // Moderators can read user profiles but only update specific fields
      allow read: if isModerator();
      allow update: if isModerator() && 
        request.resource.data.keys().hasOnly(['accountStatus', 'updatedAt']) &&
        request.resource.data.accountStatus in ['active', 'suspended'];
      
      // Prevent users from changing their own role or permissions
      allow update: if isAuthenticated() && request.auth.uid == userId &&
        (!('role' in request.resource.data) || request.resource.data.role == resource.data.role) &&
        (!('permissions' in request.resource.data) || request.resource.data.permissions == resource.data.permissions);
    }
    
    // Admins collection - controlled access
    match /admins/{adminId} {
      // Allow read access for authenticated admins
      allow read: if isAuthenticated() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      // Allow write access to self or other admins
      allow write: if isAuthenticated() && (request.auth.uid == adminId || exists(/databases/$(database)/documents/admins/$(request.auth.uid)));
      
      // Allow unauthenticated reads for login purposes (username lookup)
      // This is safe because we only expose email field which is needed for login
      allow read: if true;
    }
    
    // User carts - enhanced security
    match /carts/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isAdmin();
    }
    
    // User wishlists - enhanced security
    match /wishlists/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isAdmin();
    }
    
    // Orders collection - enhanced security
    match /orders/{orderId} {
      // Users can read their own orders and create new ones
      allow read: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId;
      
      // Admins have full access to all orders
      allow read, write: if isAdmin();
    }
    
    // Order Status History collection - for order tracking
    match /order_status_history/{historyId} {
      // Users can read status history for their own orders
      allow read: if isAuthenticated();
      
      // System can create status history entries
      allow create: if isAuthenticated();
      
      // Admins have full access
      allow read, write: if isAdmin();
    }
    
    // Reviews collection - enhanced moderation
    match /reviews/{reviewId} {
      // Anyone can read approved reviews
      allow read: if true;
      
      // Authenticated users can create reviews
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId;
      
      // Users can update their own reviews
      allow update: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
      
      // Moderators can approve/reject reviews
      allow update: if isModerator() &&
        request.resource.data.keys().hasOnly(['status', 'moderatedBy', 'moderatedAt', 'updatedAt']);
      
      // Admins have full access
      allow read, write: if isAdmin();
    }
    
    // Products collection - role-based access
    match /products/{productId} {
      // Anyone can read active products for shopping
      allow read: if (
        ("isActive" in resource.data && resource.data.isActive == true) ||
        !("isActive" in resource.data)
      );

      // Admins have full access to all products
      allow read, write: if isAdmin();
    }
    
    // Categories collection - role-based access
    match /categories/{categoryId} {
      // Anyone can read active categories for shopping
      allow read: if true; // Allow public read for active categories
      
      // Admins have full access to all categories
      allow read, write: if isAdmin();
    }
    
    // Error logs collection - admin only
    match /error_logs/{logId} {
      allow write: if true; // Allow error logging from client
      allow read: if isAdmin();
    }
    
    // Analytics collection - admin access
    match /analytics/{docId} {
      allow read, write: if isAdmin();
    }
    
    // Notifications collection - enhanced security
    match /notifications/{notificationId} {
      // Users can read and update their own notifications
      allow read, update: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
      
      // System can create notifications
      allow create: if isAuthenticated();
      
      // Admins have full access
      allow read, write: if isAdmin();
    }
    
    // Discount codes collection
    match /discounts/{discountId} {
      // Admins can read/write all discount codes
      allow read, write: if isAdmin();
      
      // Authenticated users can read active discount codes for validation
      allow read: if isAuthenticated() && resource.data.isActive == true;
    }
    
    // Discount applications collection
    match /discountApplications/{applicationId} {
      // Admins can read/write all applications
      allow read, write: if isAdmin();
      
      // Users can create applications and read their own
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }
    
    // Site configuration collection
    match /site_config/{configId} {
      // Anyone can read site configuration (for public display)
      allow read: if true;
      
      // Only admins can modify site configuration
      allow write: if isAdmin();
    }
    
    // Admin stats collection - admin only
    match /admin_stats/{statId} {
      allow read, write: if isAdmin();
    }
    
    // User stats collection - admin access for analytics
    match /user_stats/{statId} {
      allow read, write: if isAdmin();
      // Users can read their own stats
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }
    
    // Audit trail collection - admin only
    match /audit_trail/{auditId} {
      allow write: if isAuthenticated(); // Allow audit logging
      allow read: if isAdmin();
    }
    
    // Give admins full access to any collection as fallback
    // This ensures admins can access all current and future collections
    match /{document=**} {
      allow read, write: if isAdmin();
      // Deny all other access that's not explicitly allowed above
      allow read, write: if false;
    }
  }
}